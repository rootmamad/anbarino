{% extends 'products/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}لیست خرابی{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'products/css/cart.css' %}">
{% endblock %}

{% block content %}
<h2 class="section-heading text-center"><i class="fas fa-shopping-cart me-2"></i>لیست خرابی</h2>

{% if cart_items %}
  {% if request.user.is_superuser %}
    <div class="cart-container">
      {% for item in cart_items %}
      <div class="cart-product-card" data-product-id="{{ item.product.id }}">
        <div class="cart-left">
          <img class="product-image" src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
        </div>
        <div class="cart-right">
          <p class="name">{{ item.product.name }}</p>
          <p class="price">قیمت: {{ item.product.price }} تومان</p>
          <p class="stock">تعداد خرابی: {{ item.quantity }} عدد</p>
          <img class="barcode" src="{{ item.product.qr_code.url }}" alt="بارکد">

          <div class="quantity-controls">
            <!-- فرم تایید -->
            <form method="post" action="{% url 'damaged_action' item.id %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="approve">
              <button type="submit" class="btn-approve">✔ </button>
            </form>

            <!-- فرم رد -->
            <form method="post" action="{% url 'damaged_action' item.id %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="reject">
              <button type="submit" class="btn-reject">✖ </button>
            </form>
          </div>

          {% if error_map|get_item:item.id %}
          <div class="alert alert-danger mt-2 d-flex align-items-center error-box" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error_map|get_item:item.id }}
          </div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <!-- فرم کاربران عادی -->
    <form method="post" action="{% url 'damaged_finalize' %}">
      {% csrf_token %}
      <div class="cart-container">
  {% for item in cart_items %}
  <div class="cart-product-card" data-product-id="{{ item.product.id }}">
    <div class="cart-left">
      <img class="product-image" src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
    </div>
    <div class="cart-right">
      <p class="name">{{ item.product.name }}</p>
      <p class="price">قیمت: {{ item.product.price }} تومان</p>
      <!-- اضافه کردن data-stock برای هر محصول -->
      <p class="stock" data-stock="{{ item.product.quantity }}">موجودی: {{ item.product.quantity }} عدد</p>
      <img class="barcode" src="{{ item.product.qr_code.url }}" alt="بارکد">

      <div class="quantity-controls">
        <!-- کلاس ها دقیقاً با JS هماهنگ شدند -->
        <button type="button" class="btn-minus">-</button>
        <span class="quantity">{{ item.quantity }}</span>
        <button type="button" class="btn-plus">+</button>
        <input type="hidden" name="quantities_{{ item.id }}" value="{{ item.quantity }}" class="quantity-input">
      </div>

      {% if error_map|get_item:item.id %}
      <div class="alert alert-danger mt-2 d-flex align-items-center error-box" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error_map|get_item:item.id }}
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>



      <div class="text-center mt-4">
        <button class="btn btn-success btn-lg px-5" id="submit-cart">ثبت نهایی خرابی ها</button>
      </div>
    </form>
  {% endif %}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="{% static 'products/js/dr.js' %}"></script>

{% else %}
<p class="text-center2">لیست خرابی شما خالی است.</p>
{% endif %}
{% endblock %}
