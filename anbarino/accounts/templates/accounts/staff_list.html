{% extends "products/base.html" %}
{% load static %}
{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ú©Ù†Ø§Ù†{% endblock %}

{% block extra_head %}
<style>
  body { background:#f5f6fa; font-family:tahoma,sans-serif; }
  .form-wrapper, .staff-table {
    max-width: 800px;
    margin: 30px auto;
    background: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    direction: rtl;
    text-align: right;
  }
  .form-title { text-align:center; margin-bottom:25px; font-size:1.6rem; color:#333; font-weight:bold; }
  .staff-form label { font-weight:bold; margin-top:10px; display:block; color:#444; }
  .staff-form input, .staff-form select { width:100%; padding:10px 12px; margin-top:5px; border:1px solid #ccc; border-radius:8px; font-size:1rem; }
  .btn-submit { width:100%; padding:12px; margin-top:20px; font-size:1.1rem; background:#28a745; color:#fff; border:none; border-radius:10px; cursor:pointer; transition:0.3s; }
  .btn-submit:hover { background:#218838; transform:translateY(-2px); }
  table { width:100%; border-collapse:collapse; margin-top:30px; }
  table th, table td { border:1px solid #ddd; padding:12px; text-align:center; }
  table th { background-color:#f8f9fa; }
  .action-btn { padding:6px 10px; margin:2px; border:none; border-radius:6px; font-size:0.9rem; cursor:pointer; color:#fff; }
  .btn-edit { background:#ffc107; }
  .btn-delete { background:#dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="form-wrapper">
  <h2 class="form-title">â• Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯</h2>
  <form id="staff-form" class="staff-form">
    {% csrf_token %}
    <label for="id_full_name">Ù†Ø§Ù…:</label>
    <input type="text" name="full_name" id="id_full_name" required>

    <label for="id_national_code">Ú©Ø¯ Ù…Ù„ÛŒ:</label>
    <input type="text" name="national_code" id="id_national_code" required pattern="\d{10}" title="Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯">

    <label for="id_phone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³:</label>
    <input type="text" name="phone" id="id_phone" required pattern="\d{10}" title="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ 10 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯">

    <label for="id_email">Ø§ÛŒÙ…ÛŒÙ„:</label>
    <input type="email" name="email" id="id_email" required>

    <label for="id_is_staff">Ù†Ù‚Ø´:</label>
    <select name="is_staff" id="id_is_staff" required>
      <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
      <option value="true">ØµÙ†Ø¯ÙˆÙ‚â€ŒØ¯Ø§Ø±</option>
      <option value="false">Ù‚ÙØ³Ù‡â€ŒØ¯Ø§Ø±</option>
    </select>

    <button type="submit" class="btn-submit">Ø«Ø¨Øª Ú©Ø§Ø±Ù…Ù†Ø¯</button>
  </form>
</div>

<div class="staff-table">
  <h2 class="form-title">ğŸ‘¥ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ú©Ù†Ø§Ù†</h2>
  <table>
    <thead>
      <tr>
        <th>Ù†Ø§Ù…</th>
        <th>Ú©Ø¯ Ù…Ù„ÛŒ</th>
        <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th>
        <th>Ø§ÛŒÙ…ÛŒÙ„</th>
        <th>Ù†Ù‚Ø´</th>
        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
      </tr>
    </thead>
    <tbody id="staff-list">
      {% for staff in staff_list %}
      <tr data-staff-id="{{ staff.id }}">
        <td class="staff-full-name">{{ staff.full_name }}</td>
        <td class="staff-national-code">{{ staff.national_code }}</td>
        <td class="staff-phone">{{ staff.phone }}</td>
        <td class="staff-email">{{ staff.email }}</td>
        <td class="staff-role">{% if staff.is_staff %}ØµÙ†Ø¯ÙˆÙ‚â€ŒØ¯Ø§Ø±{% else %}Ù‚ÙØ³Ù‡â€ŒØ¯Ø§Ø±{% endif %}</td>
        <td>
          <button class="action-btn btn-edit" onclick="editStaff({{ staff.id }})">ÙˆÛŒØ±Ø§ÛŒØ´</button>
          <button class="action-btn btn-delete" onclick="deleteStaff({{ staff.id }})">Ø­Ø°Ù</button>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="6">Ù‡ÛŒÚ† Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  // ================= Ø«Ø¨Øª Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¬Ø¯ÛŒØ¯ =================
  document.getElementById("staff-form").addEventListener("submit", function(e){
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    fetch("{% url 'add_staff' %}", {
  method: "POST",
  body: new FormData(form),
  headers: { "X-CSRFToken": csrfToken },
  credentials: "same-origin"
})
.then(res => res.json())
.then(data => {
  if(data.status === "success"){
    Swal.fire({ icon:"success", title:"Ú©Ø§Ø±Ù…Ù†Ø¯ Ø«Ø¨Øª Ø´Ø¯", timer:1500, showConfirmButton:false })
      .then(()=> location.reload());
  } else {
    Swal.fire("Ø®Ø·Ø§", data.message || "Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯", "error");
  }
})
.catch(err=>{
  console.error(err);
  Swal.fire("Ø®Ø·Ø§", "Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯!", "error");
});

  });

  // ================= ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯ =================
  function editStaff(id){
    const row = document.querySelector(`tr[data-staff-id="${id}"]`);
    const full_name = row.querySelector(".staff-full-name").innerText.trim();
    const national_code = row.querySelector(".staff-national-code").innerText.trim();
    const phone = row.querySelector(".staff-phone").innerText.trim();
    const email = row.querySelector(".staff-email").innerText.trim();
    const roleText = row.querySelector(".staff-role").innerText.trim();
    const is_staff_val = roleText === "ØµÙ†Ø¯ÙˆÙ‚â€ŒØ¯Ø§Ø±";

    Swal.fire({
      title: "ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯",
      html: `
        <input id="swal-full-name" class="swal2-input" placeholder="Ù†Ø§Ù…" value="${full_name}">
        <input id="swal-national-code" class="swal2-input" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" value="${national_code}">
        <input id="swal-phone" class="swal2-input" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" value="${phone}">
        <input id="swal-email" class="swal2-input" placeholder="Ø§ÛŒÙ…ÛŒÙ„" value="${email}">
        <select id="swal-is-staff" class="swal2-input">
          <option value="true" ${is_staff_val ? "selected":""}>ØµÙ†Ø¯ÙˆÙ‚â€ŒØ¯Ø§Ø±</option>
          <option value="false" ${!is_staff_val ? "selected":""}>Ù‚ÙØ³Ù‡â€ŒØ¯Ø§Ø±</option>
        </select>
      `,
      showCancelButton:true,
      confirmButtonText:"Ø«Ø¨Øª ØªØºÛŒÛŒØ±Ø§Øª",
      cancelButtonText:"Ù„ØºÙˆ",
      preConfirm: ()=>({
        full_name: document.getElementById("swal-full-name").value,
        national_code: document.getElementById("swal-national-code").value,
        phone: document.getElementById("swal-phone").value,
        email: document.getElementById("swal-email").value,
        is_staff: document.getElementById("swal-is-staff").value === "true"
      })
    }).then(result=>{
      if(result.isConfirmed){
        fetch(`/staff/edit/${id}/`,{
          method:"POST",
          headers:{"Content-Type":"application/json", "X-CSRFToken":csrfToken},
          body: JSON.stringify(result.value)
        })
        .then(res=>res.json())
        .then(data=>{
          if(data.status==="success"){
            Swal.fire("Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯","ØªØºÛŒÛŒØ±Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯","success").then(()=>location.reload());
          } else {
            Swal.fire("Ø®Ø·Ø§", data.message || "Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯","error");
          }
        }).catch(err=>{
          console.error(err);
          Swal.fire("Ø®Ø·Ø§","Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.","error");
        });
      }
    });
  }

  // ================= Ø­Ø°Ù Ú©Ø§Ø±Ù…Ù†Ø¯ =================
  function deleteStaff(id){
    Swal.fire({
      title:"Ø­Ø°Ù Ú©Ø§Ø±Ù…Ù†Ø¯",
      text:"Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú©Ø§Ø±Ù…Ù†Ø¯ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ",
      icon:"warning",
      showCancelButton:true,
      confirmButtonColor:"#d33",
      cancelButtonColor:"#aaa",
      confirmButtonText:"Ø¨Ù„Ù‡ØŒ Ø­Ø°Ù Ú©Ù†",
      cancelButtonText:"Ù„ØºÙˆ"
    }).then(result=>{
      if(result.isConfirmed){
        fetch(`/staff/delete/${id}/`,{
          method:"POST",
          headers:{"X-CSRFToken":csrfToken},
          credentials:"same-origin"
        })
        .then(res=>res.json())
        .then(data=>{
          if(data.status==="success"){
            Swal.fire("Ø­Ø°Ù Ø´Ø¯!","Ú©Ø§Ø±Ù…Ù†Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.","success").then(()=>location.reload());
          } else {
            Swal.fire("Ø®Ø·Ø§", data.message || "Ø­Ø°Ù Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯.","error");
          }
        }).catch(err=>{
          console.error(err);
          Swal.fire("Ø®Ø·Ø§","Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.","error");
        });
      }
    });
  }
</script>
{% endblock %}
